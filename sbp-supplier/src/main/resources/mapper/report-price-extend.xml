<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wq.sbp.dao.ReportPriceExtendDao">
 	<select id="listQuoteListBySupId" resultType="QuoteDTO">
 		SELECT
 			REPLACE (
				ecb.app_logo,
				#{param2},
				#{param1}
			) AS src,
			ii.car_mark title,
			irpe.ins_id insId,
			DATE_FORMAT(irpe.create_date,'%Y-%m-%d' ) askTimeStr,
			(
				SELECT
					COUNT(*)
				FROM
					ibs_report_price irp
				WHERE
					irp.ins_id = ii.id
				AND irp.member_id = #{supplierMemberId}
				AND irp.state = '0'
			) count,
		(SELECT
				iii.`name`
			FROM
				ibs_insurance_info iii
			LEFT JOIN ibs_report_price irp ON iii.id = irp.ins_info_id
			WHERE
				irp.ins_id = ii.id
			AND irp.member_id = #{supplierMemberId}
			AND irp.state = '0' limit 0,1) `name`
		FROM
			ibs_report_price_extend irpe
		LEFT JOIN ibs_insurance ii ON irpe.ins_id = ii.id
		LEFT JOIN es_car_brand ecb ON ii.car_brand_id = ecb.car_brand_id
		WHERE
			irpe.supplier_member_id = #{supplierMemberId}
		AND
			irpe.report_state=0
		AND 
			irpe.quote_deadline>NOW()
		ORDER BY
			irpe.id DESC
 	</select>
 	<update id="updateReportPriceExtendSelective">
 		UPDATE 
 			ibs_report_price_extend 
 		SET
 			gmt_modify=NOW()
			<if test="reportState != null">
				,report_state = #{reportState}
			</if>
			<if test="gmtQuote != null">
				,gmt_quote = #{gmtQuote}
			</if>
			<if test="expressMoney != null">
				,express_money = #{expressMoney}
			</if>
			<if test="taxRate != null">
				,tax_rate = #{taxRate}
			</if>		
		WHERE
			ins_id = #{insId}
		AND 
			supplier_member_id = #{supplierMemberId}
 	</update>
</mapper>